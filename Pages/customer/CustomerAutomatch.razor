@page "/admin/customers/match/{Id:int}"
@using Casus_Applicatie.Models
@using Casus_Applicatie.Pages.accommodations
@using Casus_Applicatie.Services
@inject IJSRuntime JS
@inject CustomerService CustomerService
@inject AccommodationService AccommodationService
@inject PropertyService PropertyService


<PageTitle>Customers | Vind de beste accommodatie voor u!</PageTitle>
<div class="d-grid mb-3">
    <button class="btn btn-danger btn-lg" type="button" @onclick="GoBack">Terug</button>
    <EditForm Model="@manualWishes" OnValidSubmit="ManualFilter">
        @foreach (var property in properties)
        {
            <div class="mb-3">
                <label>@property.Name: @manualWishes[property.PropertyId]</label>
                <input type="range" 
                       class="form-range"
                       min="0" 
                       max="100" 
                       @bind-value="manualWishes[property.PropertyId]" 
                       @bind-value:event="oninput" />
            </div>
        }

        <button type="submit" class="btn btn-success">Find Matches</button>
    </EditForm>
</div>
@if (results == null)
{   
    <p><em>Loading...</em></p>
}
else if (!results.Any())
{
    <p>No accommodations found.</p>
}
else
{
    
    
    <div class="container my-5">
        <div class="row row-cols-1 row-cols-md-3 g-4">
            @foreach (var result in results)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="position-absolute top-0 end-0 m-2">
                            <span class="badge bg-success fs-6">Score: @result.Score</span>
                        </div>

                        <img src="@result.Accommodation.ImageUrl" class="card-img-top" style="height: 200px; object-fit: cover;">
            
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@result.Accommodation.Name</h5>
                            <p class="card-text text-muted">@result.Accommodation.Description</p>
                            <a href="/detail/@result.Accommodation.AccommodationId" class="btn btn-primary mt-auto">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

}


@code {
    [Parameter]
    public int Id { get; set; }


    private List<FilterResult> results = new List<FilterResult>();
    private Customer selectedCustomer;
    private List<Customerwish> customerWishes = new List<Customerwish>();

    
    private List<Property> properties = new List<Property>();
    private Dictionary<int, int> manualWishes = new Dictionary<int, int>();
    
    
    protected override async Task OnInitializedAsync()
    {
        selectedCustomer = await CustomerService.GetByIdAsync(Id);
        customerWishes = await CustomerService.getCustomerWishesById(Id);
        properties = await PropertyService.GetAllProperties();
        
        foreach (var p in properties)
        {
            manualWishes[p.PropertyId] = int.TryParse(customerWishes.FirstOrDefault(cw => cw.PropertyId == p.PropertyId)?.Value, out var val) ? val : 0;        
        }
        await filter(customerWishes);
    }


    private async Task filter(List<Customerwish> customerWishes)
    {
        
        // Step 1. Retrieve all accommodations
        List<Accommodation> allAccommodations = await AccommodationService.GetAllAsync();
        var tempResults = new List<FilterResult>();

        
        // Step 2. Loop through accommodations and add totalled score to tempResults
        foreach (var accommodation in allAccommodations)
        {
            List<Property> properties = await PropertyService.GetPropertiesByAccommodation(accommodation.AccommodationId);
            int score = 0;

            foreach (var property in properties)
            {
                var wish = customerWishes.FirstOrDefault(cw => cw.PropertyId == property.PropertyId);
                if (wish != null && int.TryParse(wish.Value, out int value))
                {
                    score += value;
                }
            }
        
            tempResults.Add(new FilterResult { 
                Accommodation = accommodation, 
                Score = score 
            });
        }

        // Step 3. Order by score, descending
        results = tempResults.OrderByDescending(r => r.Score).ToList();
        
        // Step 4. Display,
        StateHasChanged();
    }

    public class FilterResult
    {
        public Accommodation Accommodation { get; set; }
        public int Score { get; set; }
    }

    
    private async Task GoBack()
    {
        await JS.InvokeVoidAsync("history.back");
    }



    private async Task ManualFilter()
    {
        // Interpretates the form input and generates a list of wishes based on those.
        var psuedoWishes = manualWishes.Where(kvp => kvp.Value > 0)
            .Select(kvp => new Customerwish 
            { 
                PropertyId = kvp.Key, 
                Value = kvp.Value.ToString() 
            })
            .ToList();

        await filter(psuedoWishes);
    }
}